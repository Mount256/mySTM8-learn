#include "dht11.h"

/*************************************************************************
                             初始化 DHT11
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
无返回值
*************************************************************************/
void DHT11_Init (void)
{
  DHT11_DLY_ms(1000);
  DHT11_DQ_OUT();
  DHT11_DQ_LOW();
}

/*************************************************************************
                             复位 DHT11
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
无返回值
*************************************************************************/
void DHT11_Reset (void)
{
  DHT11_DQ_OUT();
  
  DHT11_DQ_LOW();
  DHT11_DLY_ms(20);    // 拉低 18-30ms
  DHT11_DQ_HIGH();
  DHT11_DLY_us(30);    // 拉高 10-20us
}

/*************************************************************************
                             检测 DHT11
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
返回值：错误代码
*************************************************************************/
ErrorStatus DHT11_Check (void)
{
  uint8_t cnt = 0;
  
  DHT11_DQ_IN();   
  
  /* 等待 DHT11 拉低 81-85us */ 
  while((DHT11_DQ_STATUS() != RESET) && (cnt < RESPONSE_MAX_TIME_1))  
  {
    cnt++; 
    DHT11_DLY_us(1);
  }
  
  if(cnt >= RESPONSE_MAX_TIME_1)
  {
    printf("ERROR: CHECK 0x01\r\n");
    return ERROR;
  }
  else
  {
    cnt = 0;
  }
  
  /* 再等待 DHT11 拉高 85-88us */
  while((DHT11_DQ_STATUS() == RESET) && (cnt < RESPONSE_MAX_TIME_2))  
  {
    cnt++; 
    DHT11_DLY_us(1);
  }
  
  /* 可以开始传输数据了 */
  if(cnt >= RESPONSE_MAX_TIME_2)
  {
    printf("ERROR: CHECK 0x02\r\n");
    return ERROR;
  }
  else
  {
    return SUCCESS;
  }
}

/*************************************************************************
                             读取一个位
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
返回值：0 或 1
*************************************************************************/
static BitStatus DHT11_ReadBit (void)
{
  uint8_t cnt = 0;
  BitStatus bit;
  
  DHT11_DQ_IN();
  
  /* 开始读之前，DHT11 先拉低 52-56us */
  while((DHT11_DQ_STATUS() != RESET) && (cnt < READ_LOW_TIME))  
  {
    cnt++; 
    DHT11_DLY_us(1);
  }
  
  cnt = 0;
  
  /* 然后 DHT11 拉高 23-27us */
  while((DHT11_DQ_STATUS() == RESET) && (cnt < READ_HIGH_TIME))  
  {
    cnt++; 
    DHT11_DLY_us(1);
  }
  
  /* 数据 0：DHT11 拉高 23-27us */
  /* 数据 1：DHT11 拉高 68-74us */
  
   DHT11_DLY_us(40);
  
  /* 执行到此处，若 DHT11 仍拉高电平，则说明是数据 1，否则是数据 0 */
  bit = DHT11_DQ_STATUS();
  
  return bit;
}

/*************************************************************************
                             读取一个字节
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
返回值：一字节数据
*************************************************************************/
static uint8_t DHT11_ReadByte (void)
{
  uint8_t i;
  uint8_t data = 0;
  
  for (i = 0; i < 8; i++)
  {
    data <<= 1;
    data |= (uint8_t) DHT11_ReadBit();
  }
  
  return data;
}

/*************************************************************************
                             读取温湿度数据
--------------------------------------------------------------------------
无参数
--------------------------------------------------------------------------
返回值：温湿度数据
*************************************************************************/
TempHumiDataTypeDef DHT11_ReadData (void)
{
  ErrorStatus err;
  TempHumiDataTypeDef data;
  
  DHT11_Reset();
  err = DHT11_Check();
  
  if (err != ERROR)
  {
    data.Flag    = ERROR;
    data.HumiMSB = DHT11_ReadByte();
    data.HumiLSB = DHT11_ReadByte();
    data.TempMSB = DHT11_ReadByte();
    data.TempLSB = DHT11_ReadByte();
    data.Parity  = DHT11_ReadByte();
    
    if (data.HumiMSB + data.HumiLSB + data.TempMSB + data.TempLSB == data.Parity)
    {
      data.Flag = SUCCESS;
    }
  }
  
  return data;
}

/*************************************************************************
                             软件延时（ms级别）
--------------------------------------------------------------------------
nCount：延时长度
--------------------------------------------------------------------------
无返回值
*************************************************************************/
static void DHT11_DLY_ms (uint16_t nCount)
{
  while(nCount--)
  {
    DHT11_DLY_us(1000);
  }
}

/*************************************************************************
                             软件延时（us级别）
--------------------------------------------------------------------------
nCount：延时长度
--------------------------------------------------------------------------
无返回值
*************************************************************************/
static void DHT11_DLY_us (uint16_t nCount)
{
  nCount *= 3;
  while(--nCount);
}
